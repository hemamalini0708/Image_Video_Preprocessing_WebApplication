<!!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>online photo & video toolbox</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script async src="https://docs.opencv.org/4.5.5/opencv.js" onload="initializeOpenCV();"></script>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #0a0e17, #1a1f2d);
      color: #ffffff;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    h1 {
      font-size: 2.8rem;
      margin-bottom: 30px;
      color: #00bcd4;
      text-align: center;
      font-weight: 700;
      text-shadow: 0 0 15px rgba(0, 188, 212, 0.6);
      position: relative;
      padding-bottom: 15px;
    }

    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 120px;
      height: 4px;
      background: linear-gradient(90deg, transparent, #00bcd4, transparent);
      border-radius: 2px;
    }

    h2 {
      font-size: 2rem;
      margin-bottom: 25px;
      color: #00bcd4;
      text-align: center;
      font-weight: 600;
      text-shadow: 0 0 12px rgba(0, 188, 212, 0.5);
    }

    h3 {
      font-size: 1.4rem;
      color: #00bcd4;
      text-align: center;
      margin: 20px 0;
      font-weight: 600;
    }

    .main-button, .tech-button {
      background: linear-gradient(145deg, #1a1a2e, #16213e);
      color: #ffffff;
      border: 2px solid #00bcd4;
      padding: 14px 26px;
      border-radius: 14px;
      margin: 10px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      box-shadow: 0 4px 20px rgba(0, 188, 212, 0.3);
      white-space: nowrap;
      text-align: center;
      position: relative;
      overflow: hidden;
      z-index: 1;
    }

    .main-button::before, .tech-button::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #00bcd4, #00a3b8);
      transition: all 0.4s ease;
      z-index: -1;
    }

    .main-button:hover::before, .tech-button:hover::before {
      width: 100%;
    }

    .main-button:hover, .tech-button:hover {
      color: #121212;
      transform: translateY(-4px);
      box-shadow: 0 6px 25px rgba(0, 188, 212, 0.5);
    }

    .main-button:hover i, .tech-button:hover i {
      color: #121212;
    }

    .main-button i, .tech-button i {
      color: #00bcd4;
      transition: color 0.3s ease;
      min-width: 18px;
      text-align: center;
      font-size: 1.3rem;
    }

    .button-section {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: 10px;
    }

    .tech-buttons-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-top: 30px;
      width: 100%;
      max-width: 900px;
    }

    footer {
      margin-top: 60px;
      font-size: 1rem;
      color: #aaa;
      text-align: center;
      font-weight: 500;
      padding: 20px;
      border-top: 1px solid rgba(0, 188, 212, 0.2);
      width: 100%;
    }

    .page {
      display: none;
      min-height: calc(100vh - 100px);
      padding: 40px 20px;
      animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(30px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .active-page {
      display: block;
    }

    .upload-container {
      background: linear-gradient(145deg, #1a1a2e, #16213e);
      border: 2px solid #00bcd4;
      border-radius: 20px;
      padding: 30px;
      width: 90%;
      max-width: 800px;
      margin: 0 auto 40px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 188, 212, 0.2);
      position: relative;
      overflow: hidden;
    }

    .upload-container::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #00bcd4, transparent, #00bcd4);
      z-index: -1;
      animation: borderAnimation 6s linear infinite;
      background-size: 400%;
    }

    @keyframes borderAnimation {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .upload-label {
      display: block;
      margin-bottom: 20px;
      font-size: 1.2rem;
      font-weight: 600;
      color: #00bcd4;
    }

    .file-input-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      margin-bottom: 20px;
    }

    .file-input-wrapper input[type=file] {
      font-size: 100px;
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-input-button {
      background: #00bcd4;
      color: #121212;
      padding: 12px 30px;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 15px rgba(0, 188, 212, 0.4);
    }

    .file-input-button:hover {
      background: #00a3b8;
      transform: scale(1.05);
    }

    .image-preview-container {
      margin-top: 30px;
      background: rgba(30, 30, 40, 0.6);
      border-radius: 15px;
      padding: 20px;
      min-height: 250px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px dashed #00bcd4;
    }

    .image-preview {
      max-width: 100%;
      max-height: 350px;
      border-radius: 10px;
      display: none;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    .placeholder-text {
      color: #777;
      font-style: italic;
      font-size: 1.1rem;
    }

    .action-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .result-section {
      margin: 30px auto;
      background: rgba(30, 30, 40, 0.6);
      border-radius: 15px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 2px solid #00bcd4;
      max-width: 90%;
    }

    .result-title {
      color: #00bcd4;
      margin-bottom: 15px;
      font-weight: 600;
      font-size: 1.4rem;
    }

    .save-button-container {
      margin-top: 15px;
      display: flex;
      justify-content: center;
    }

    .weight-controls {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 25px;
      margin: 30px auto;
      max-width: 600px;
      border: 2px solid #00bcd4;
    }

    .slider-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 20px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      width: 100%;
      margin-bottom: 10px;
      font-weight: 600;
      color: #00bcd4;
    }

    .slider-value {
      background: rgba(0, 188, 212, 0.2);
      padding: 3px 10px;
      border-radius: 10px;
      min-width: 60px;
      text-align: center;
    }

    .weight-slider {
      width: 100%;
      height: 10px;
      -webkit-appearance: none;
      background: rgba(0, 188, 212, 0.2);
      border-radius: 5px;
      outline: none;
    }

    .weight-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      background: #00bcd4;
      cursor: pointer;
      transition: all 0.2s;
    }

    .roi-canvas-container {
      position: relative;
      margin: 20px auto;
      max-width: 90%;
    }

    .roi-canvas {
      max-width: 100%;
      max-height: 400px;
      border-radius: 10px;
      border: 2px solid #00bcd4;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      cursor: crosshair;
    }

    .roi-instructions {
      color: #aaa;
      font-size: 0.9rem;
      margin-top: 10px;
      text-align: center;
      font-style: italic;
    }

    .roi-selection {
      position: absolute;
      border: 2px dashed #00ff00;
      background-color: rgba(0, 255, 0, 0.1);
      pointer-events: none;
      display: none;
    }

    .roi-buttons {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }

    .drawing-controls {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border: 2px solid #00bcd4;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .shape-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 20px;
    }

    .shape-button {
      background: rgba(0, 188, 212, 0.2);
      border: 1px solid #00bcd4;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
    }

    .shape-button:hover, .shape-button.active {
      background: #00bcd4;
      color: #121212;
    }

    .color-picker {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .color-label {
      font-weight: 600;
      color: #00bcd4;
    }

    .line-width {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .line-width input {
      width: 80px;
      padding: 8px;
      background: rgba(30, 30, 40, 0.8);
      border: 1px solid #00bcd4;
      border-radius: 5px;
      color: white;
      text-align: center;
    }

    .controls-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      flex-wrap: wrap;
    }

    .dimension-input {
      background: rgba(30, 30, 40, 0.8);
      border: 1px solid #00bcd4;
      border-radius: 8px;
      padding: 12px 15px;
      color: white;
      font-size: 1rem;
      width: 120px;
      text-align: center;
    }

    .comparison-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-top: 20px;
    }

    .text-controls {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border: 2px solid #00bcd4;
    }

    .control-group {
      margin-bottom: 15px;
    }

    .control-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 600;
      color: #00bcd4;
    }

    .face-controls {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin: 20px auto;
      max-width: 600px;
      border: 2px solid #00bcd4;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .face-control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }

    .face-control-label {
      font-weight: 600;
      color: #00bcd4;
      min-width: 120px;
    }

    .face-control-input {
      flex: 1;
      padding: 10px;
      background: rgba(30, 30, 40, 0.8);
      border: 1px solid #00bcd4;
      border-radius: 5px;
      color: white;
      text-align: center;
    }

    .detection-canvas-container {
      position: relative;
      margin: 20px auto;
      max-width: 90%;
    }

    .detection-canvas {
      max-width: 100%;
      max-height: 400px;
      border-radius: 10px;
      border: 2px solid #00bcd4;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    .model-status {
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      margin: 15px 0;
    }

    .model-loading {
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }

    .model-ready {
      background: rgba(40, 167, 69, 0.2);
      color: #28a745;
    }

    .model-error {
      background: rgba(220, 53, 69, 0.2);
      color: #dc3545;
    }

    .video-player {
      width: 100%;
      max-height: 400px;
      border-radius: 10px;
      border: 2px solid #00bcd4;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
      background: #000;
    }

    .video-controls {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .frame-gallery {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(30, 30, 40, 0.6);
      border-radius: 10px;
    }

    .frame-item {
      position: relative;
      border: 1px solid #00bcd4;
      border-radius: 5px;
      overflow: hidden;
      height: 100px;
    }

    .frame-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .frame-number {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      text-align: center;
      font-size: 0.8rem;
      padding: 2px;
    }

    .video-overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-size: 1.2rem;
      background: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10;
      pointer-events: none;
    }

    .edge-controls {
      background: rgba(30, 30, 40, 0.8);
      border-radius: 15px;
      padding: 20px;
      margin: 20px 0;
      border: 2px solid #00bcd4;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 15px;
    }

    .slider-group {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 500px;
    }

    .slider-row {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }

    .slider-row label {
      min-width: 120px;
      font-weight: 600;
      color: #00bcd4;
    }

    .slider-row input {
      flex: 1;
    }

    .slider-row .value-display {
      min-width: 60px;
      text-align: center;
      background: rgba(0, 188, 212, 0.2);
      padding: 5px 10px;
      border-radius: 10px;
      margin-left: 15px;
    }

    .video-info {
      display: flex;
      justify-content: space-between;
      background: rgba(0, 188, 212, 0.1);
      border-radius: 10px;
      padding: 10px 15px;
      margin: 10px 0;
      font-size: 0.9rem;
    }

    .notification {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      border-radius: 10px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .notification.show {
      opacity: 1;
    }

    .notification.success {
      background: linear-gradient(145deg, #28a745, #218838);
    }

    .notification.error {
      background: linear-gradient(145deg, #dc3545, #c82333);
    }

    .notification.warning {
      background: linear-gradient(145deg, #ffc107, #e0a800);
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 2.2rem;
      }
      h2 {
        font-size: 1.8rem;
      }
      .tech-buttons-container {
        grid-template-columns: 1fr;
      }
      .action-buttons {
        flex-direction: column;
        align-items: center;
      }
      .image-grid, .comparison-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      .roi-buttons, .shape-buttons {
        flex-direction: column;
        align-items: center;
      }
      .face-control-row {
        flex-direction: column;
        align-items: flex-start;
      }
      .face-control-input {
        width: 100%;
      }
      .frame-gallery {
        grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      }
      .video-info {
        flex-direction: column;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <!-- Notification Container -->
  <div id="notificationContainer"></div>

  <div class="container">
    <!-- Main Page -->
    <div id="mainPage" class="page active-page">
      <h1>Data Science Internship by Vihara Tech</h1>
      <p style="text-align: center; color: gray; font-size: 18px;">
             Click. Eidt. Create. – Seamless Browser-Based Photo & Video Tool Box
      </p>

      <div class="button-section">
        <button class="main-button"><i class="fas fa-sliders-h"></i><span>Select Technique</span></button>

        <div class="tech-buttons-container">
          <button class="tech-button" onclick="showPage('showImagePage')"><i class="fas fa-image"></i><span>Show Image</span></button>
          <button class="tech-button" onclick="showPage('addImagePage')"><i class="fas fa-plus-circle"></i><span>Add Image</span></button>
          <button class="tech-button" onclick="showPage('reshapePage')"><i class="fas fa-expand-arrows-alt"></i><span>Reshape Image</span></button>
          <button class="tech-button" onclick="showPage('weightAgePage')"><i class="fas fa-weight-hanging"></i><span>WeightAge</span></button>
          <button class="tech-button" onclick="showPage('roiPage')"><i class="fas fa-draw-polygon"></i><span>ROI (Region Of Interest)</span></button>
          <button class="tech-button" onclick="showPage('geometricShapesPage')"><i class="fas fa-shapes"></i><span>Geometric Shapes</span></button>
          <button class="tech-button" onclick="showPage('textOnImagePage')"><i class="fas fa-font"></i><span>Text on Image</span></button>
          <button class="tech-button" onclick="showPage('dateTimePage')"><i class="fas fa-calendar-alt"></i><span>Date Time on Image</span></button>
          <button class="tech-button" onclick="showPage('faceDetectionPage')"><i class="fas fa-user-circle"></i><span>Face Detection (Image)</span></button>
          <button class="tech-button" onclick="showPage('faceDetectionVideoPage')"><i class="fas fa-video"></i><span>Face Detection (Video)</span></button>
          <button class="tech-button" onclick="showPage('edgeDetectionPage')"><i class="fas fa-border-all"></i><span>Edge Detection</span></button>
        </div>
      </div>
    </div>

    <!-- Show Image Page -->
    <div id="showImagePage" class="page">
      <h2>Show Image</h2>
      <div class="upload-container">
        <label class="upload-label">Upload Your Image</label>
        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Image</span>
          </button>
          <input type="file" id="imageUpload" accept="image/*">
        </div>
        <p id="fileName">No file selected</p>
        <div class="image-preview-container">
          <img id="previewImage" class="image-preview" src="#" alt="Image Preview">
          <div id="imagePlaceholder" class="placeholder-text">Your uploaded image will appear here</div>
        </div>
        <div class="save-button-container">
          <button class="tech-button" id="saveShowImage">
            <i class="fas fa-download"></i>
            <span>Save Image</span>
          </button>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
        <button class="tech-button" id="showButton">
          <i class="fas fa-eye"></i>
          <span>Show Image</span>
        </button>
      </div>
    </div>

    <!-- Add Image Page (Blending) -->
    <div id="addImagePage" class="page">
      <h2>Add Images (Blending)</h2>
      <div class="upload-container">
        <div class="image-grid">
          <div class="image-grid-item">
            <label class="upload-label">Image 1</label>
            <div class="file-input-wrapper">
              <button class="file-input-button">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Choose Image</span>
              </button>
              <input type="file" id="imageUpload1" accept="image/*">
            </div>
            <p id="fileName1">No file selected</p>
            <div class="image-preview-container">
              <img id="previewImage1" class="image-preview" src="#" alt="Image 1 Preview">
              <div id="imagePlaceholder1" class="placeholder-text">Image 1 will appear here</div>
            </div>
          </div>
          <div class="image-grid-item">
            <label class="upload-label">Image 2</label>
            <div class="file-input-wrapper">
              <button class="file-input-button">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Choose Image</span>
              </button>
              <input type="file" id="imageUpload2" accept="image/*">
            </div>
            <p id="fileName2">No file selected</p>
            <div class="image-preview-container">
              <img id="previewImage2" class="image-preview" src="#" alt="Image 2 Preview">
              <div id="imagePlaceholder2" class="placeholder-text">Image 2 will appear here</div>
            </div>
          </div>
        </div>
        <div class="result-section">
          <div class="result-title">Blended Result</div>
          <div class="image-preview-container">
            <img id="blendResult" class="image-preview" src="#" alt="Blended Image">
            <div id="blendPlaceholder" class="placeholder-text">Blended image will appear here</div>
          </div>
          <div class="save-button-container">
            <button class="tech-button" id="saveBlendImage">
              <i class="fas fa-download"></i>
              <span>Save Blended Image</span>
            </button>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
        <button class="tech-button" id="blendButton">
          <i class="fas fa-blender"></i>
          <span>Blend Images</span>
        </button>
      </div>
    </div>

    <!-- Reshape Image Page -->
    <div id="reshapePage" class="page">
      <h2>Reshape Image</h2>
      <div class="upload-container">
        <label class="upload-label">Upload Your Image</label>
        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Image</span>
          </button>
          <input type="file" id="reshapeUpload" accept="image/*">
        </div>
        <p id="reshapeFileName">No file selected</p>
        <div class="image-preview-container">
          <img id="reshapePreview" class="image-preview" src="#" alt="Image Preview">
          <div id="reshapePlaceholder" class="placeholder-text">Your uploaded image will appear here</div>
        </div>
        <div class="controls-container">
          <div class="dimension-group">
            <label class="dimension-label">New Width</label>
            <input type="number" id="newWidth" class="dimension-input" min="10" max="2000" placeholder="Width">
          </div>
          <div class="dimension-group">
            <label class="dimension-label">New Height</label>
            <input type="number" id="newHeight" class="dimension-input" min="10" max="2000" placeholder="Height">
          </div>
        </div>
        <div class="result-section">
          <div class="result-title">Original vs Reshaped</div>
          <div class="comparison-container">
            <div class="image-grid-item">
              <h3>Original Image</h3>
              <div class="image-preview-container">
                <img id="originalImage" class="image-preview" src="#" alt="Original Image">
                <div id="originalPlaceholder" class="placeholder-text">Original image</div>
              </div>
            </div>
            <div class="image-grid-item">
              <h3>Reshaped Image</h3>
              <div class="image-preview-container">
                <img id="reshapedImage" class="image-preview" src="#" alt="Reshaped Image">
                <div id="reshapedPlaceholder" class="placeholder-text">Reshaped image will appear here</div>
              </div>
              <div class="save-button-container">
                <button class="tech-button" id="saveReshapedImage">
                  <i class="fas fa-download"></i>
                  <span>Save Reshaped Image</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
        <button class="tech-button" id="reshapeButton">
          <i class="fas fa-crop-alt"></i>
          <span>Reshape Image</span>
        </button>
      </div>
    </div>

    <!-- WeightAge Page -->
    <div id="weightAgePage" class="page">
      <h2>Weighted Image Blending</h2>
      <div class="upload-container">
        <div class="image-grid">
          <div class="image-grid-item">
            <label class="upload-label">Image 1</label>
            <div class="file-input-wrapper">
              <button class="file-input-button">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Choose Image</span>
              </button>
              <input type="file" id="weightImage1" accept="image/*">
            </div>
            <p id="weightFileName1">No file selected</p>
            <div class="image-preview-container">
              <img id="weightPreview1" class="image-preview" src="#" alt="Image 1 Preview">
              <div id="weightPlaceholder1" class="placeholder-text">Image 1 will appear here</div>
            </div>
          </div>
          <div class="image-grid-item">
            <label class="upload-label">Image 2</label>
            <div class="file-input-wrapper">
              <button class="file-input-button">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Choose Image</span>
              </button>
              <input type="file" id="weightImage2" accept="image/*">
            </div>
            <p id="weightFileName2">No file selected</p>
            <div class="image-preview-container">
              <img id="weightPreview2" class="image-preview" src="#" alt="Image 2 Preview">
              <div id="weightPlaceholder2" class="placeholder-text">Image 2 will appear here</div>
            </div>
          </div>
        </div>
        <div class="weight-controls">
          <div class="slider-container">
            <div class="slider-label">
              <span>Image 1 Weight</span>
              <span class="slider-value" id="weightValue">0.5</span>
            </div>
            <input type="range" min="0" max="1" step="0.01" value="0.5" class="weight-slider" id="weightSlider">
            <div class="weight-display">
              <span>0 (Image 2)</span>
              <span>1 (Image 1)</span>
            </div>
          </div>
          <div class="action-buttons">
            <button class="tech-button" id="applyWeightButton">
              <i class="fas fa-balance-scale"></i>
              <span>Apply Weight</span>
            </button>
          </div>
        </div>
        <div class="result-section">
          <div class="result-title">Weighted Blend Result</div>
          <div class="image-preview-container">
            <img id="weightResult" class="image-preview" src="#" alt="Weighted Blend Result">
            <div id="weightResultPlaceholder" class="placeholder-text">Weighted blend result will appear here</div>
          </div>
          <div class="save-button-container">
            <button class="tech-button" id="saveWeightedImage">
              <i class="fas fa-download"></i>
              <span>Save Weighted Image</span>
            </button>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
      </div>
    </div>

    <!-- ROI Page -->
    <div id="roiPage" class="page">
      <h2>Region Of Interest (ROI)</h2>
      <div class="upload-container">
        <label class="upload-label">Upload Your Image</label>
        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Image</span>
          </button>
          <input type="file" id="roiUpload" accept="image/*">
        </div>
        <p id="roiFileName">No file selected</p>
        <div class="roi-canvas-container">
          <canvas id="roiCanvas" class="roi-canvas"></canvas>
          <div id="roiSelection" class="roi-selection"></div>
          <div class="roi-instructions">Draw a rectangle on the image to select a region</div>
        </div>
        <div class="roi-buttons">
          <button class="tech-button" id="extractRoiButton">
            <i class="fas fa-crop"></i>
            <span>Extract ROI</span>
          </button>
          <button class="tech-button" id="restartButton">
            <i class="fas fa-redo"></i>
            <span>Restart</span>
          </button>
        </div>
        <div class="result-section">
          <div class="result-title">ROI Result</div>
          <div class="image-preview-container">
            <img id="roiResult" class="image-preview" src="#" alt="ROI Result">
            <div id="roiResultPlaceholder" class="placeholder-text">ROI result will appear here</div>
          </div>
          <div class="save-button-container">
            <button class="tech-button" id="saveRoiImage">
              <i class="fas fa-download"></i>
              <span>Save ROI Image</span>
            </button>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
      </div>
    </div>

    <!-- Geometric Shapes Page -->
    <div id="geometricShapesPage" class="page">
      <h2>Geometric Shapes Drawing</h2>
      <div class="upload-container">
        <label class="upload-label">Upload Your Image</label>
        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Image</span>
          </button>
          <input type="file" id="shapesUpload" accept="image/*">
        </div>
        <p id="shapesFileName">No file selected</p>
        <div class="drawing-controls">
          <div class="shape-buttons">
            <button class="shape-button active" id="lineButton">Line</button>
            <button class="shape-button" id="rectangleButton">Rectangle</button>
            <button class="shape-button" id="circleButton">Circle</button>
            <!-- Added Arrow Button -->
            <button class="shape-button" id="arrowButton">Arrow</button>
          </div>
          <div class="color-picker">
            <span class="color-label">Color:</span>
            <input type="color" id="colorPicker" value="#00bcd4">
          </div>
          <div class="line-width">
            <span class="color-label">Line Width:</span>
            <input type="number" id="lineWidth" min="1" max="20" value="3">
          </div>
        </div>
        <div class="roi-canvas-container">
          <canvas id="drawingCanvas" class="roi-canvas"></canvas>
          <div class="roi-instructions">Click and drag on the image to draw the selected shape</div>
        </div>
        <div class="action-buttons">
          <button class="tech-button" id="clearButton">
            <i class="fas fa-eraser"></i>
            <span>Clear Drawing</span>
          </button>
          <button class="tech-button" id="saveButton">
            <i class="fas fa-download"></i>
            <span>Save Image</span>
          </button>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
      </div>
    </div>

    <!-- Text on Image Page -->
    <div id="textOnImagePage" class="page">
      <h2>Add Text to Image</h2>
      <div class="upload-container">
        <label class="upload-label">Upload Your Image</label>
        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Image</span>
          </button>
          <input type="file" id="textImageUpload" accept="image/*">
        </div>
        <p id="textFileName">No file selected</p>
        <div class="image-preview-container">
          <img id="textPreview" class="image-preview" src="#" alt="Image Preview">
          <div id="textPlaceholder" class="placeholder-text">Your uploaded image will appear here</div>
        </div>
        <div class="text-controls">
          <div class="control-group">
            <label for="textInput">Text to Add:</label>
            <input type="text" id="textInput" placeholder="Enter text to add to the image">
          </div>
          <div class="control-group">
            <label for="textX">X Position:</label>
            <input type="number" id="textX" min="0" max="2000" value="50" placeholder="X coordinate">
          </div>
          <div class="control-group">
            <label for="textY">Y Position:</label>
            <input type="number" id="textY" min="0" max="2000" value="50" placeholder="Y coordinate">
          </div>
          <div class="control-group">
            <label for="textSize">Font Size (px):</label>
            <input type="number" id="textSize" min="10" max="100" value="30" placeholder="Font size">
          </div>
          <div class="control-group">
            <label for="textColor">Text Color:</label>
            <input type="color" id="textColor" value="#ffffff">
          </div>
        </div>
        <div class="action-buttons">
          <button class="tech-button" id="addTextButton">
            <i class="fas fa-font"></i>
            <span>Add Text to Image</span>
          </button>
        </div>
        <div class="result-section">
          <div class="result-title">Image with Text</div>
          <div class="image-preview-container">
            <img id="textResult" class="image-preview" src="#" alt="Image with Text">
            <div id="textResultPlaceholder" class="placeholder-text">Text result will appear here</div>
          </div>
          <div class="save-button-container">
            <button class="tech-button" id="saveTextImage">
              <i class="fas fa-download"></i>
              <span>Save Text Image</span>
            </button>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
      </div>
    </div>

    <!-- Date Time on Image Page -->
    <div id="dateTimePage" class="page">
      <h2>Add Date/Time to Image</h2>

      <div class="upload-container">
        <label class="upload-label">Upload Your Image</label>

        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Image</span>
          </button>
          <input type="file" id="dateImageUpload" accept="image/*">
        </div>

        <p id="dateFileName">No file selected</p>

        <div class="image-preview-container">
          <img id="datePreview" class="image-preview" src="#" alt="Image Preview">
          <div id="datePlaceholder" class="placeholder-text">Your uploaded image will appear here</div>
        </div>

        <div class="text-controls">
          <div class="control-group">
            <label for="dateFormat">Date/Time Format:</label>
            <select id="dateFormat">
              <option value="datetime">Date and Time</option>
              <option value="date">Date Only</option>
              <option value="time">Time Only</option>
              <option value="custom">Custom Format</option>
            </select>
          </div>

          <div class="control-group" id="customFormatGroup" style="display: none;">
            <label for="customFormat">Custom Format:</label>
            <input type="text" id="customFormat" placeholder="e.g. YYYY-MM-DD HH:mm:ss">
          </div>

          <div class="control-group">
            <label for="dateX">X Position:</label>
            <input type="number" id="dateX" min="0" max="2000" value="50" placeholder="X coordinate">
          </div>

          <div class="control-group">
            <label for="dateY">Y Position:</label>
            <input type="number" id="dateY" min="0" max="2000" value="50" placeholder="Y coordinate">
          </div>

          <div class="control-group">
            <label for="dateSize">Font Size (px):</label>
            <input type="number" id="dateSize" min="10" max="100" value="30" placeholder="Font size">
          </div>

          <div class="control-group">
            <label for="dateColor">Text Color:</label>
            <input type="color" id="dateColor" value="#ffffff">
          </div>
        </div>

        <div class="action-buttons">
          <button class="tech-button" id="addDateTimeButton">
            <i class="fas fa-calendar-alt"></i>
            <span>Add Date/Time to Image</span>
          </button>
        </div>

        <div class="result-section">
          <div class="result-title">Image with Date/Time</div>
          <div class="image-preview-container">
            <img id="dateResult" class="image-preview" src="#" alt="Image with Date/Time">
            <div id="dateResultPlaceholder" class="placeholder-text">Date/Time result will appear here</div>
          </div>
          <div class="save-button-container">
            <button class="tech-button" id="saveDateTimeImage">
              <i class="fas fa-download"></i>
              <span>Save Date/Time Image</span>
            </button>
          </div>
        </div>
      </div>

      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
      </div>
    </div>

    <!-- Face Detection Page (Image) -->
    <div id="faceDetectionPage" class="page">
      <h2>Face Detection (Image)</h2>
      <div class="upload-container">
        <label class="upload-label">Upload Your Image</label>
        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Image</span>
          </button>
          <input type="file" id="faceImageUpload" accept="image/*">
        </div>
        <p id="faceFileName">No file selected</p>
        <div class="image-preview-container">
          <img id="facePreview" class="image-preview" src="#" alt="Image Preview">
          <div id="facePlaceholder" class="placeholder-text">Your uploaded image will appear here</div>
        </div>
        <div class="model-status model-loading" id="modelStatus">
          <i class="fas fa-spinner fa-spin"></i> Loading OpenCV.js and face detection model...
        </div>
        <div class="face-controls" id="faceControls" style="display:none">
          <div class="face-control-row">
            <span class="face-control-label">Rectangle Color:</span>
            <input type="color" id="rectColor" class="face-control-input" value="#00bcd4">
          </div>
          <div class="face-control-row">
            <span class="face-control-label">Line Thickness:</span>
            <input type="number" id="rectThickness" class="face-control-input" min="1" max="10" value="3">
          </div>
        </div>
        <div class="action-buttons" id="detectionButtons" style="display:none">
          <button class="tech-button" id="detectFacesButton">
            <i class="fas fa-search"></i>
            <span>Detect Faces</span>
          </button>
          <button class="tech-button" id="clearFacesButton">
            <i class="fas fa-eraser"></i>
            <span>Clear Detection</span>
          </button>
        </div>
        <div class="detection-canvas-container">
          <canvas id="detectionCanvas" class="detection-canvas"></canvas>
        </div>
        <div class="result-section">
          <div class="result-title">Detection Result</div>
          <div class="image-preview-container">
            <img id="detectionResult" class="image-preview" src="#" alt="Face Detection Result">
            <div id="detectionPlaceholder" class="placeholder-text">Face detection result will appear here</div>
          </div>
          <div class="save-button-container">
            <button class="tech-button" id="saveFaceDetectionImage">
              <i class="fas fa-download"></i>
              <span>Save Detected Image</span>
            </button>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
      </div>
    </div>

    <!-- Face Detection Page (Video) -->
    <div id="faceDetectionVideoPage" class="page">
      <h2>Face Detection (Video)</h2>

      <div class="upload-container">
        <label class="upload-label">Upload Your Video</label>

        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Video</span>
          </button>
          <input type="file" id="faceVideoUpload" accept="video/*">
        </div>

        <p id="faceVideoFileName">No file selected</p>
        <div id="videoInfo" class="video-info" style="display: none;">
          <div class="video-info-item">
            <span class="video-info-label">Duration</span>
            <span class="video-info-value" id="videoDuration">0s</span>
          </div>
          <div class="video-info-item">
            <span class="video-info-label">Frames</span>
            <span class="video-info-value" id="videoFrames">0</span>
          </div>
          <div class="video-info-item">
            <span class="video-info-label">Size</span>
            <span class="video-info-value" id="videoSize">0 MB</span>
          </div>
        </div>

        <div class="model-status model-loading" id="videoModelStatus">
          <i class="fas fa-spinner fa-spin"></i> Loading OpenCV.js and face detection model...
        </div>

        <div class="face-controls" id="videoFaceControls" style="display:none">
          <div class="face-control-row">
            <span class="face-control-label">Rectangle Color:</span>
            <input type="color" id="videoRectColor" class="face-control-input" value="#00bcd4">
          </div>

          <div class="face-control-row">
            <span class="face-control-label">Line Thickness:</span>
            <input type="number" id="videoRectThickness" class="face-control-input" min="1" max="10" value="3">
          </div>
        </div>

        <div class="action-buttons" id="videoDetectionButtons" style="display:none">
          <button class="tech-button" id="startDetectionButton">
            <i class="fas fa-play"></i>
            <span>Start Detection</span>
          </button>

          <button class="tech-button" id="stopDetectionButton">
            <i class="fas fa-stop"></i>
            <span>Stop Detection</span>
          </button>

          <button class="tech-button" id="clearVideoDetectionButton">
            <i class="fas fa-eraser"></i>
            <span>Clear</span>
          </button>

          <button class="tech-button" id="frameCountButton">
            <i class="fas fa-film"></i>
            <span>Frame Count</span>
          </button>

          <button class="tech-button" id="dateTimeButton">
            <i class="fas fa-calendar"></i>
            <span>Date Time</span>
          </button>

          <button class="tech-button" id="saveVideoFrameButton">
            <i class="fas fa-download"></i>
            <span>Save Frame</span>
          </button>
        </div>

        <div class="video-controls" style="position: relative;">
          <video id="inputVideo" class="video-player" controls style="display:none"></video>
          <canvas id="videoDetectionCanvas" class="video-player" style="display:none"></canvas>
          <div id="videoOverlay" class="video-overlay" style="display: none;"></div>
        </div>

        <div class="frame-gallery" id="frameGallery" style="display: none;">
          <div class="result-title">Extracted Frames</div>
          <!-- Frames will be added here -->
        </div>
      </div>

      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
      </div>
    </div>


    <!-- Edge Detection Page -->
    <div id="edgeDetectionPage" class="page">
      <h2>Edge Detection</h2>
      <div class="upload-container">
        <label class="upload-label">Upload Your Image</label>
        <div class="file-input-wrapper">
          <button class="file-input-button">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Choose Image</span>
          </button>
          <input type="file" id="edgeUpload" accept="image/*">
        </div>
        <p id="edgeFileName">No file selected</p>
        <div class="image-preview-container">
          <img id="edgePreview" class="image-preview" src="#" alt="Image Preview">
          <div id="edgePlaceholder" class="placeholder-text">Your uploaded image will appear here</div>
        </div>
        <div class="edge-controls">
          <div class="slider-group">
            <div class="slider-row">
              <label for="threshold1">Threshold 1:</label>
              <input type="range" id="threshold1" min="0" max="500" value="100">
              <div class="value-display" id="threshold1Value">100</div>
            </div>
            <div class="slider-row">
              <label for="threshold2">Threshold 2:</label>
              <input type="range" id="threshold2" min="0" max="500" value="200">
              <div class="value-display" id="threshold2Value">200</div>
            </div>
            <div class="slider-row">
              <label for="edgeType">Edge Type:</label>
              <select id="edgeType" class="edge-type-select">
                <option value="canny">Canny Edge Detection</option>
                <option value="sobel">Sobel Edge Detection</option>
                <option value="laplacian">Laplacian Edge Detection</option>
              </select>
            </div>
          </div>
          <div class="action-buttons">
            <button class="tech-button" id="detectEdgesBtn">
              <i class="fas fa-border-all"></i>
              <span>Detect Edges</span>
            </button>
            <button class="tech-button" id="detectCornersBtn">
              <i class="fas fa-dot-circle"></i>
              <span>Detect Corners</span>
            </button>
          </div>
        </div>
        <div class="result-section">
          <div class="result-title">Edge Detection Result</div>
          <div class="image-preview-container">
            <img id="edgeResult" class="image-preview" src="#" alt="Edge Detection Result">
            <div id="edgeResultPlaceholder" class="placeholder-text">Edge detection result will appear here</div>
          </div>
          <div class="save-button-container">
            <button class="tech-button" id="saveEdgeImage">
              <i class="fas fa-download"></i>
              <span>Save Edge Image</span>
            </button>
          </div>
        </div>
      </div>
      <div class="action-buttons">
        <button class="main-button" onclick="showPage('mainPage')">
          <i class="fas fa-sliders-h"></i>
          <span>Select Technique</span>
        </button>
      </div>
    </div>

    <footer>
      Project done by Hema Malini | Vihara Tech Internship
    </footer>
  </div>

  <script>
    // =============== GLOBAL FUNCTIONS ===============
    // Show/hide pages
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(page => {
        page.classList.remove('active-page');
      });
      document.getElementById(pageId).classList.add('active-page');
    }

    // Notification system
    function showNotification(message, type) {
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      container.appendChild(notification);

      // Show notification
      setTimeout(() => {
        notification.classList.add('show');
      }, 10);

      // Hide after delay
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
          container.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Helper to convert hex to RGB
    function hexToRgb(hex) {
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
      } : { r: 0, g: 188, b: 212 };
    }

    // =============== OPENCV INITIALIZATION ===============
    let openCvReady = false;
    let haarCascade = null;

    function initializeOpenCV() {
      cv['onRuntimeInitialized'] = () => {
        console.log('OpenCV is ready!');
        loadHaarCascade();
      };
    }

    async function loadHaarCascade() {
      try {
        const response = await fetch('https://raw.githubusercontent.com/opencv/opencv/master/data/haarcascades/haarcascade_frontalface_default.xml');
        if (!response.ok) {
          throw new Error('Failed to load Haar cascade file');
        }
        const cascadeData = await response.text();

        // Update model status
        document.getElementById('modelStatus').textContent = "OpenCV loaded. Loading face detection model...";
        document.getElementById('videoModelStatus').textContent = "OpenCV loaded. Loading face detection model...";

        // Create the cascade classifier
        haarCascade = new cv.CascadeClassifier();

        // Convert the cascade data to Uint8Array and write to the file system
        const cascadeBuffer = new Uint8Array(cascadeData.length);
        for (let i = 0; i < cascadeData.length; i++) {
          cascadeBuffer[i] = cascadeData.charCodeAt(i);
        }

        // Write to the virtual file system
        cv.FS_createDataFile('/', 'haarcascade_frontalface_default.xml', cascadeBuffer, true, false, false);

        // Load the cascade
        haarCascade.load('haarcascade_frontalface_default.xml');

        // Update status
        document.getElementById('modelStatus').textContent = "Face detection model loaded!";
        document.getElementById('modelStatus').className = "model-status model-ready";

        document.getElementById('videoModelStatus').textContent = "Face detection model loaded!";
        document.getElementById('videoModelStatus').className = "model-status model-ready";

        // Show controls
        document.getElementById('faceControls').style.display = 'block';
        document.getElementById('detectionButtons').style.display = 'flex';

        document.getElementById('videoFaceControls').style.display = 'block';
        document.getElementById('videoDetectionButtons').style.display = 'flex';

        openCvReady = true;

        showNotification('OpenCV and face detection model loaded successfully!', 'success');
      } catch (error) {
        console.error('Error loading Haar cascade:', error);
        document.getElementById('modelStatus').textContent = "Error loading face detection model: " + error.message;
        document.getElementById('modelStatus').className = "model-status model-error";

        document.getElementById('videoModelStatus').textContent = "Error loading face detection model: " + error.message;
        document.getElementById('videoModelStatus').className = "model-status model-error";

        showNotification('Failed to load face detection model', 'error');
      }
    }

    // Convert hex to OpenCV scalar (BGR format)
    function hexToScalar(hex) {
      const rgb = hexToRgb(hex);
      return new cv.Scalar(rgb.b, rgb.g, rgb.r, 255);
    }

    // ==================== SHOW IMAGE ====================
    const imageUpload = document.getElementById('imageUpload');
    const previewImage = document.getElementById('previewImage');
    const fileName = document.getElementById('fileName');
    const imagePlaceholder = document.getElementById('imagePlaceholder');
    const showButton = document.getElementById('showButton');
    const saveShowImage = document.getElementById('saveShowImage');

    imageUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        fileName.textContent = `Selected: ${file.name}`;
        fileName.style.color = '#00bcd4';
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          previewImage.style.display = 'none';
        }
        reader.readAsDataURL(file);
      } else {
        fileName.textContent = 'No file selected';
        fileName.style.color = '';
      }
    });

    showButton.addEventListener('click', function() {
      if (previewImage.src && previewImage.src !== window.location.href) {
        previewImage.style.display = 'block';
        imagePlaceholder.style.display = 'none';
        previewImage.style.transform = 'scale(0.95)';
        previewImage.style.opacity = '0';
        setTimeout(() => {
          previewImage.style.transition = 'all 0.5s ease';
          previewImage.style.transform = 'scale(1)';
          previewImage.style.opacity = '1';
        }, 50);
      } else {
        fileName.textContent = 'Please upload an image first!';
        fileName.style.color = '#ff6b6b';
        setTimeout(() => { fileName.style.color = ''; }, 2000);
      }
    });

    saveShowImage.addEventListener('click', function() {
      if (!previewImage.src || previewImage.src.startsWith('#')) {
        showNotification('Please upload an image first!', 'error');
        return;
      }
      const link = document.createElement('a');
      link.download = 'image.png';
      link.href = previewImage.src;
      link.click();
    });


    // ==================== ADD IMAGE (BLENDING) ====================
    const imageUpload1 = document.getElementById('imageUpload1');
    const previewImage1 = document.getElementById('previewImage1');
    const fileName1 = document.getElementById('fileName1');
    const imagePlaceholder1 = document.getElementById('imagePlaceholder1');
    const imageUpload2 = document.getElementById('imageUpload2');
    const previewImage2 = document.getElementById('previewImage2');
    const fileName2 = document.getElementById('fileName2');
    const imagePlaceholder2 = document.getElementById('imagePlaceholder2');
    const blendResult = document.getElementById('blendResult');
    const blendPlaceholder = document.getElementById('blendPlaceholder');
    const blendButton = document.getElementById('blendButton');
    const saveBlendImage = document.getElementById('saveBlendImage');

    let image1Data = null;
    let image2Data = null;

    // Handle image 1 upload
    imageUpload1.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        fileName1.textContent = `Selected: ${file.name}`;
        fileName1.style.color = '#00bcd4';

        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage1.src = e.target.result;
          previewImage1.style.display = 'block';
          imagePlaceholder1.style.display = 'none';
          image1Data = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        fileName1.textContent = 'No file selected';
        fileName1.style.color = '';
      }
    });

    // Handle image 2 upload
    imageUpload2.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        fileName2.textContent = `Selected: ${file.name}`;
        fileName2.style.color = '#00bcd4';

        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage2.src = e.target.result;
          previewImage2.style.display = 'block';
          imagePlaceholder2.style.display = 'none';
          image2Data = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        fileName2.textContent = 'No file selected';
        fileName2.style.color = '';
      }
    });

    // Blend images
    blendButton.addEventListener('click', function() {
      if (!image1Data || !image2Data) {
        showNotification('Please upload both images first!', 'error');
        return;
      }

      // Create canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Create images
      const img1 = new Image();
      const img2 = new Image();

      img1.onload = function() {
        img2.onload = function() {
          // Set canvas dimensions to match images
          const width = Math.max(img1.width, img2.width);
          const height = Math.max(img1.height, img2.height);
          canvas.width = width;
          canvas.height = height;

          // Draw images
          ctx.globalAlpha = 0.5;
          ctx.drawImage(img1, 0, 0);
          ctx.drawImage(img2, 0, 0);

          // Set result
          blendResult.src = canvas.toDataURL();
          blendResult.style.display = 'block';
          blendPlaceholder.style.display = 'none';

          // Animation
          blendResult.style.transform = 'scale(0.95)';
          blendResult.style.opacity = '0';

          setTimeout(() => {
            blendResult.style.transition = 'all 0.7s ease';
            blendResult.style.transform = 'scale(1)';
            blendResult.style.opacity = '1';
          }, 50);

          fileName1.textContent = `Blended: ${imageUpload1.files[0].name}`;
          fileName2.textContent = `Blended: ${imageUpload2.files[0].name}`;
          showNotification('Images blended successfully!', 'success');
        };
        img2.src = image2Data;
      };
      img1.src = image1Data;
    });

    // Save blended image
    saveBlendImage.addEventListener('click', function() {
      if (!blendResult.src || blendResult.src.startsWith('#')) {
        showNotification('Please blend images first!', 'error');
        return;
      }

      const link = document.createElement('a');
      link.download = 'blended-image.png';
      link.href = blendResult.src;
      link.click();
      showNotification('Blended image saved!', 'success');
    });

    // ==================== RESHAPE IMAGE ====================
    const reshapeUpload = document.getElementById('reshapeUpload');
    const reshapePreview = document.getElementById('reshapePreview');
    const reshapeFileName = document.getElementById('reshapeFileName');
    const reshapePlaceholder = document.getElementById('reshapePlaceholder');
    const reshapeButton = document.getElementById('reshapeButton');
    const newWidth = document.getElementById('newWidth');
    const newHeight = document.getElementById('newHeight');
    const originalImage = document.getElementById('originalImage');
    const originalPlaceholder = document.getElementById('originalPlaceholder');
    const reshapedImage = document.getElementById('reshapedImage');
    const reshapedPlaceholder = document.getElementById('reshapedPlaceholder');
    const saveReshapedImage = document.getElementById('saveReshapedImage');

    let reshapeImageData = null;

    reshapeUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        reshapeFileName.textContent = `Selected: ${file.name}`;
        reshapeFileName.style.color = '#00bcd4';

        const reader = new FileReader();
        reader.onload = function(e) {
          reshapePreview.src = e.target.result;
          reshapePreview.style.display = 'block';
          reshapePlaceholder.style.display = 'none';

          originalImage.src = e.target.result;
          originalImage.style.display = 'block';
          originalPlaceholder.style.display = 'none';

          reshapeImageData = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        reshapeFileName.textContent = 'No file selected';
        reshapeFileName.style.color = '';
      }
    });

    reshapeButton.addEventListener('click', function() {
      if (!reshapeImageData) {
        showNotification('Please upload an image first!', 'error');
        return;
      }

      const width = parseInt(newWidth.value) || 300;
      const height = parseInt(newHeight.value) || 300;

      if (width <= 0 || height <= 0) {
        showNotification('Please enter valid width and height values', 'error');
        return;
      }

      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, width, height);

        reshapedImage.src = canvas.toDataURL();
        reshapedImage.style.display = 'block';
        reshapedPlaceholder.style.display = 'none';

        // Animation
        reshapedImage.style.transform = 'scale(0.95)';
        reshapedImage.style.opacity = '0';

        setTimeout(() => {
          reshapedImage.style.transition = 'all 0.7s ease';
          reshapedImage.style.transform = 'scale(1)';
          reshapedImage.style.opacity = '1';
        }, 50);
        showNotification('Image reshaped successfully!', 'success');
      };
      img.src = reshapeImageData;
    });

    // Save reshaped image
    saveReshapedImage.addEventListener('click', function() {
      if (!reshapedImage.src || reshapedImage.src.startsWith('#')) {
        showNotification('Please reshape an image first!', 'error');
        return;
      }

      const link = document.createElement('a');
      link.download = 'reshaped-image.png';
      link.href = reshapedImage.src;
      link.click();
      showNotification('Reshaped image saved!', 'success');
    });

    // ==================== WEIGHTED BLENDING ====================
    const weightImage1 = document.getElementById('weightImage1');
    const weightPreview1 = document.getElementById('weightPreview1');
    const weightFileName1 = document.getElementById('weightFileName1');
    const weightPlaceholder1 = document.getElementById('weightPlaceholder1');

    const weightImage2 = document.getElementById('weightImage2');
    const weightPreview2 = document.getElementById('weightPreview2');
    const weightFileName2 = document.getElementById('weightFileName2');
    const weightPlaceholder2 = document.getElementById('weightPlaceholder2');

    const weightSlider = document.getElementById('weightSlider');
    const weightValue = document.getElementById('weightValue');
    const applyWeightButton = document.getElementById('applyWeightButton');
    const weightResult = document.getElementById('weightResult');
    const weightResultPlaceholder = document.getElementById('weightResultPlaceholder');
    const saveWeightedImage = document.getElementById('saveWeightedImage');

    let weightImage1Data = null;
    let weightImage2Data = null;

    // Handle weight image 1 upload
    weightImage1.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        weightFileName1.textContent = `Selected: ${file.name}`;
        weightFileName1.style.color = '#00bcd4';

        const reader = new FileReader();
        reader.onload = function(e) {
          weightPreview1.src = e.target.result;
          weightPreview1.style.display = 'block';
          weightPlaceholder1.style.display = 'none';
          weightImage1Data = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        weightFileName1.textContent = 'No file selected';
        weightFileName1.style.color = '';
      }
    });

    // Handle weight image 2 upload
    weightImage2.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        weightFileName2.textContent = `Selected: ${file.name}`;
        weightFileName2.style.color = '#00bcd4';

        const reader = new FileReader();
        reader.onload = function(e) {
          weightPreview2.src = e.target.result;
          weightPreview2.style.display = 'block';
          weightPlaceholder2.style.display = 'none';
          weightImage2Data = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        weightFileName2.textContent = 'No file selected';
        weightFileName2.style.color = '';
      }
    });

    // Update weight value display
    weightSlider.addEventListener('input', function() {
      weightValue.textContent = weightSlider.value;
    });

    // Apply weighted blending
    applyWeightButton.addEventListener('click', function() {
      if (!weightImage1Data || !weightImage2Data) {
        showNotification('Please upload both images first!', 'error');
        return;
      }

      const weight = parseFloat(weightSlider.value);

      // Create canvas
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Create images
      const img1 = new Image();
      const img2 = new Image();

      img1.onload = function() {
        img2.onload = function() {
          // Set canvas dimensions to match images
          const width = Math.max(img1.width, img2.width);
          const height = Math.max(img1.height, img2.height);
          canvas.width = width;
          canvas.height = height;

          // Draw image 1
          ctx.globalAlpha = weight;
          ctx.drawImage(img1, 0, 0);

          // Draw image 2
          ctx.globalAlpha = 1 - weight;
          ctx.drawImage(img2, 0, 0);

          // Reset global alpha
          ctx.globalAlpha = 1.0;

          // Set result
          weightResult.src = canvas.toDataURL();
          weightResult.style.display = 'block';
          weightResultPlaceholder.style.display = 'none';

          // Animation
          weightResult.style.transform = 'scale(0.95)';
          weightResult.style.opacity = '0';

          setTimeout(() => {
            weightResult.style.transition = 'all 0.7s ease';
            weightResult.style.transform = 'scale(1)';
            weightResult.style.opacity = '1';
          }, 50);

          weightFileName1.textContent = `Weight: ${(weight * 100).toFixed(0)}% - ${weightImage1.files[0].name}`;
          weightFileName2.textContent = `Weight: ${((1 - weight) * 100).toFixed(0)}% - ${weightImage2.files[0].name}`;
          showNotification('Weighted blending applied!', 'success');
        };
        img2.src = weightImage2Data;
      };
      img1.src = weightImage1Data;
    });

    // Save weighted image
    saveWeightedImage.addEventListener('click', function() {
      if (!weightResult.src || weightResult.src.startsWith('#')) {
        showNotification('Please apply weighted blending first!', 'error');
        return;
      }

      const link = document.createElement('a');
      link.download = 'weighted-image.png';
      link.href = weightResult.src;
      link.click();
      showNotification('Weighted image saved!', 'success');
    });

    // ==================== ROI (REGION OF INTEREST) ====================
    const roiUpload = document.getElementById('roiUpload');
    const roiFileName = document.getElementById('roiFileName');
    const roiCanvas = document.getElementById('roiCanvas');
    const roiSelection = document.getElementById('roiSelection');
    const extractRoiButton = document.getElementById('extractRoiButton');
    const restartButton = document.getElementById('restartButton');
    const roiResult = document.getElementById('roiResult');
    const roiResultPlaceholder = document.getElementById('roiResultPlaceholder');
    const saveRoiImage = document.getElementById('saveRoiImage');

    let roiImage = null;
    let roiCtx = null;
    let isDragging = false;
    let startX, startY, endX, endY;

    roiUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        roiFileName.textContent = `Selected: ${file.name}`;
        roiFileName.style.color = '#00bcd4';

        const reader = new FileReader();
        reader.onload = function(e) {
          roiImage = new Image();
          roiImage.onload = function() {
            roiCanvas.width = roiImage.width;
            roiCanvas.height = roiImage.height;

            roiCtx = roiCanvas.getContext('2d');
            roiCtx.drawImage(roiImage, 0, 0);
          };
          roiImage.src = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        roiFileName.textContent = 'No file selected';
        roiFileName.style.color = '';
      }
    });

    // Mouse events for ROI selection
    roiCanvas.addEventListener('mousedown', function(e) {
      if (!roiImage) return;

      isDragging = true;
      const rect = roiCanvas.getBoundingClientRect();
      startX = e.clientX - rect.left;
      startY = e.clientY - rect.top;

      roiSelection.style.display = 'block';
      roiSelection.style.left = startX + 'px';
      roiSelection.style.top = startY + 'px';
      roiSelection.style.width = '0';
      roiSelection.style.height = '0';
    });

    roiCanvas.addEventListener('mousemove', function(e) {
      if (!isDragging || !roiImage) return;

      const rect = roiCanvas.getBoundingClientRect();
      endX = e.clientX - rect.left;
      endY = e.clientY - rect.top;

      const width = endX - startX;
      const height = endY - startY;

      roiSelection.style.width = Math.abs(width) + 'px';
      roiSelection.style.height = Math.abs(height) + 'px';

      if (width < 0) {
        roiSelection.style.left = endX + 'px';
      }

      if (height < 0) {
        roiSelection.style.top = endY + 'px';
      }
    });

    roiCanvas.addEventListener('mouseup', function() {
      isDragging = false;
    });

    // Extract ROI
    extractRoiButton.addEventListener('click', function() {
      if (!roiImage || !startX || !startY || !endX || !endY) {
        showNotification('Please select a region first!', 'error');
        return;
      }

      const x = Math.min(startX, endX);
      const y = Math.min(startY, endY);
      const width = Math.abs(endX - startX);
      const height = Math.abs(endY - startY);

      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.drawImage(roiImage, x, y, width, height, 0, 0, width, height);

      roiResult.src = canvas.toDataURL();
      roiResult.style.display = 'block';
      roiResultPlaceholder.style.display = 'none';

      // Animation
      roiResult.style.transform = 'scale(0.95)';
      roiResult.style.opacity = '0';

      setTimeout(() => {
        roiResult.style.transition = 'all 0.7s ease';
        roiResult.style.transform = 'scale(1)';
        roiResult.style.opacity = '1';
      }, 50);

      roiFileName.textContent = `ROI Extracted: ${roiUpload.files[0].name}`;
      showNotification('ROI extracted successfully!', 'success');
    });

    // Restart ROI selection
    restartButton.addEventListener('click', function() {
      if (!roiImage) {
        showNotification('Please upload an image first!', 'error');
        return;
      }

      roiCtx.drawImage(roiImage, 0, 0);
      roiSelection.style.display = 'none';
      roiResult.style.display = 'none';
      roiResultPlaceholder.style.display = 'block';
      startX = startY = endX = endY = null;

      roiFileName.textContent = `Selected: ${roiUpload.files[0].name}`;
      showNotification('ROI selection reset!', 'success');
    });

    // Save ROI image
    saveRoiImage.addEventListener('click', function() {
      if (!roiResult.src || roiResult.src.startsWith('#')) {
        showNotification('Please extract a region first!', 'error');
        return;
      }

      const link = document.createElement('a');
      link.download = 'roi-image.png';
      link.href = roiResult.src;
      link.click();
      showNotification('ROI image saved!', 'success');
    });

    // ==================== GEOMETRIC SHAPES ====================
    const shapesUpload = document.getElementById('shapesUpload');
    const shapesFileName = document.getElementById('shapesFileName');
    const drawingCanvas = document.getElementById('drawingCanvas');
    const clearButton = document.getElementById('clearButton');
    const saveButton = document.getElementById('saveButton');
    const lineButton = document.getElementById('lineButton');
    const rectangleButton = document.getElementById('rectangleButton');
    const circleButton = document.getElementById('circleButton');
    const arrowButton = document.getElementById('arrowButton'); // Added arrow button
    const colorPicker = document.getElementById('colorPicker');
    const lineWidth = document.getElementById('lineWidth');

    let drawingImage = null;
    let drawingCtx = null;
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    let currentShape = 'line';

    // Set active shape button
    function setActiveShape(shape) {
    document.querySelectorAll('.shape-button').forEach(btn => {
      btn.classList.remove('active');
    });
    document.getElementById(`${shape}Button`).classList.add('active');
    currentShape = shape;
    }

    // Handle shape button clicks
    lineButton.addEventListener('click', () => setActiveShape('line'));
    rectangleButton.addEventListener('click', () => setActiveShape('rectangle'));
    circleButton.addEventListener('click', () => setActiveShape('circle'));
    arrowButton.addEventListener('click', () => setActiveShape('arrow')); // Added arrow handler

    // Arrow drawing function
    function drawArrow(ctx, fromX, fromY, toX, toY) {
    const headLength = 15;
    const angle = Math.atan2(toY - fromY, toX - fromX);

    // Draw main line
    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.stroke();

    // Draw arrowhead
    ctx.beginPath();
    ctx.moveTo(toX, toY);
    ctx.lineTo(
      toX - headLength * Math.cos(angle - Math.PI / 6),
      toY - headLength * Math.sin(angle - Math.PI / 6)
    );
    ctx.lineTo(
      toX - headLength * Math.cos(angle + Math.PI / 6),
      toY - headLength * Math.sin(angle + Math.PI / 6)
    );
    ctx.closePath();
    ctx.fill();
    }

    shapesUpload.addEventListener('change', function(event) {
    const file = event.target.files[0];

    if (file) {
      shapesFileName.textContent = `Selected: ${file.name}`;
      shapesFileName.style.color = '#00bcd4';

      const reader = new FileReader();
      reader.onload = function(e) {
        drawingImage = new Image();
        drawingImage.onload = function() {
          drawingCanvas.width = drawingImage.width;
          drawingCanvas.height = drawingImage.height;

          drawingCtx = drawingCanvas.getContext('2d');
          drawingCtx.drawImage(drawingImage, 0, 0);
        };
        drawingImage.src = e.target.result;
      }
      reader.readAsDataURL(file);
    } else {
      shapesFileName.textContent = 'No file selected';
      shapesFileName.style.color = '';
    }
    });

    // Drawing mouse events
    drawingCanvas.addEventListener('mousedown', function(e) {
    if (!drawingImage) return;

    isDrawing = true;
    const rect = drawingCanvas.getBoundingClientRect();
    lastX = e.clientX - rect.left;
    lastY = e.clientY - rect.top;
    });

    drawingCanvas.addEventListener('mousemove', function(e) {
    if (!isDrawing || !drawingImage) return;

    const rect = drawingCanvas.getBoundingClientRect();
    const currentX = e.clientX - rect.left;
    const currentY = e.clientY - rect.top;

    // Redraw the original image
    drawingCtx.drawImage(drawingImage, 0, 0);

    // Set drawing style
    drawingCtx.strokeStyle = colorPicker.value;
    drawingCtx.lineWidth = parseInt(lineWidth.value);
    drawingCtx.fillStyle = colorPicker.value; // Needed for arrowhead
    drawingCtx.beginPath();

    switch (currentShape) {
      case 'line':
        drawingCtx.moveTo(lastX, lastY);
        drawingCtx.lineTo(currentX, currentY);
        drawingCtx.stroke();
        break;

      case 'rectangle':
        drawingCtx.rect(lastX, lastY, currentX - lastX, currentY - lastY);
        drawingCtx.stroke();
        break;

      case 'circle':
        const radius = Math.sqrt(Math.pow(currentX - lastX, 2) + Math.pow(currentY - lastY, 2));
        drawingCtx.arc(lastX, lastY, radius, 0, Math.PI * 2);
        drawingCtx.stroke();
        break;

      case 'arrow': // Added arrow case
        drawArrow(drawingCtx, lastX, lastY, currentX, currentY);
        break;
    }
    });

    drawingCanvas.addEventListener('mouseup', function() {
    isDrawing = false;
    });

    drawingCanvas.addEventListener('mouseout', function() {
    isDrawing = false;
    });

    // Clear drawing
    clearButton.addEventListener('click', function() {
    if (!drawingImage) return;

    drawingCtx.drawImage(drawingImage, 0, 0);
    shapesFileName.textContent = `Cleared: ${shapesUpload.files[0].name}`;
    showNotification('Drawing cleared!', 'success');
    });

    // Save image
    saveButton.addEventListener('click', function() {
    if (!drawingImage) return;

    const link = document.createElement('a');
    link.download = 'geometric-shapes-image.png';
    link.href = drawingCanvas.toDataURL();
    link.click();

    shapesFileName.textContent = `Saved: ${shapesUpload.files[0].name}`;
    showNotification('Image saved!', 'success');
    });

    // ==================== TEXT ON IMAGE ====================
    const textImageUpload = document.getElementById('textImageUpload');
    const textPreview = document.getElementById('textPreview');
    const textFileName = document.getElementById('textFileName');
    const textPlaceholder = document.getElementById('textPlaceholder');
    const textInput = document.getElementById('textInput');
    const textX = document.getElementById('textX');
    const textY = document.getElementById('textY');
    const textSize = document.getElementById('textSize');
    const textColor = document.getElementById('textColor');
    const addTextButton = document.getElementById('addTextButton');
    const textResult = document.getElementById('textResult');
    const textResultPlaceholder = document.getElementById('textResultPlaceholder');
    const saveTextImage = document.getElementById('saveTextImage');

    let textImageData = null;

    textImageUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        textFileName.textContent = `Selected: ${file.name}`;
        textFileName.style.color = '#00bcd4';

        const reader = new FileReader();
        reader.onload = function(e) {
          textPreview.src = e.target.result;
          textPreview.style.display = 'block';
          textPlaceholder.style.display = 'none';
          textImageData = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        textFileName.textContent = 'No file selected';
        textFileName.style.color = '';
      }
    });

    addTextButton.addEventListener('click', function() {
      if (!textImageData) {
        showNotification('Please upload an image first!', 'error');
        return;
      }

      const text = textInput.value || 'Sample Text';
      const x = parseInt(textX.value) || 50;
      const y = parseInt(textY.value) || 50;
      const size = parseInt(textSize.value) || 30;
      const color = textColor.value;

      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        // Add text
        ctx.font = `${size}px Arial`;
        ctx.fillStyle = color;
        ctx.fillText(text, x, y);

        textResult.src = canvas.toDataURL();
        textResult.style.display = 'block';
        textResultPlaceholder.style.display = 'none';

        // Animation
        textResult.style.transform = 'scale(0.95)';
        textResult.style.opacity = '0';

        setTimeout(() => {
          textResult.style.transition = 'all 0.7s ease';
          textResult.style.transform = 'scale(1)';
          textResult.style.opacity = '1';
        }, 50);

        textFileName.textContent = `Text added: ${textImageUpload.files[0].name}`;
        showNotification('Text added to image!', 'success');
      };
      img.src = textImageData;
    });

    // Save text image
    saveTextImage.addEventListener('click', function() {
      if (!textResult.src || textResult.src.startsWith('#')) {
        showNotification('Please add text to an image first!', 'error');
        return;
      }

      const link = document.createElement('a');
      link.download = 'text-image.png';
      link.href = textResult.src;
      link.click();
      showNotification('Text image saved!', 'success');
    });

    // ==================== DATE/TIME ON IMAGE ====================
    const dateImageUpload = document.getElementById('dateImageUpload');
    const datePreview = document.getElementById('datePreview');
    const dateFileName = document.getElementById('dateFileName');
    const datePlaceholder = document.getElementById('datePlaceholder');
    const dateFormat = document.getElementById('dateFormat');
    const customFormatGroup = document.getElementById('customFormatGroup');
    const customFormat = document.getElementById('customFormat');
    const dateX = document.getElementById('dateX');
    const dateY = document.getElementById('dateY');
    const dateSize = document.getElementById('dateSize');
    const dateColor = document.getElementById('dateColor');
    const addDateTimeButton = document.getElementById('addDateTimeButton');
    const dateResult = document.getElementById('dateResult');
    const dateResultPlaceholder = document.getElementById('dateResultPlaceholder');
    const saveDateTimeImage = document.getElementById('saveDateTimeImage');

    let dateImageData = null;

    // Show/hide custom format field
    dateFormat.addEventListener('change', function() {
      if (dateFormat.value === 'custom') {
        customFormatGroup.style.display = 'block';
      } else {
        customFormatGroup.style.display = 'none';
      }
    });

    dateImageUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        dateFileName.textContent = `Selected: ${file.name}`;
        dateFileName.style.color = '#00bcd4';

        const reader = new FileReader();
        reader.onload = function(e) {
          datePreview.src = e.target.result;
          datePreview.style.display = 'block';
          datePlaceholder.style.display = 'none';
          dateImageData = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        dateFileName.textContent = 'No file selected';
        dateFileName.style.color = '';
      }
    });

    addDateTimeButton.addEventListener('click', function() {
      if (!dateImageData) {
        showNotification('Please upload an image first!', 'error');
        return;
      }

      let dateTimeText = '';
      const now = new Date();

      switch (dateFormat.value) {
        case 'datetime':
          dateTimeText = now.toLocaleString();
          break;
        case 'date':
          dateTimeText = now.toLocaleDateString();
          break;
        case 'time':
          dateTimeText = now.toLocaleTimeString();
          break;
        case 'custom':
          if (!customFormat.value) {
            showNotification('Please enter a custom format', 'error');
            return;
          }
          // Simple custom format implementation
          dateTimeText = customFormat.value
            .replace('YYYY', now.getFullYear())
            .replace('MM', String(now.getMonth() + 1).padStart(2, '0'))
            .replace('DD', String(now.getDate()).padStart(2, '0'))
            .replace('HH', String(now.getHours()).padStart(2, '0'))
            .replace('mm', String(now.getMinutes()).padStart(2, '0'))
            .replace('ss', String(now.getSeconds()).padStart(2, '0'));
          break;
      }

      const x = parseInt(dateX.value) || 50;
      const y = parseInt(dateY.value) || 50;
      const size = parseInt(dateSize.value) || 30;
      const color = dateColor.value;

      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        canvas.width = img.width;
        canvas.height = img.height;

        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0);

        // Add date/time text
        ctx.font = `${size}px Arial`;
        ctx.fillStyle = color;
        ctx.fillText(dateTimeText, x, y);

        dateResult.src = canvas.toDataURL();
        dateResult.style.display = 'block';
        dateResultPlaceholder.style.display = 'none';

        // Animation
        dateResult.style.transform = 'scale(0.95)';
        dateResult.style.opacity = '0';

        setTimeout(() => {
          dateResult.style.transition = 'all 0.7s ease';
          dateResult.style.transform = 'scale(1)';
          dateResult.style.opacity = '1';
        }, 50);

        dateFileName.textContent = `Date/time added: ${dateImageUpload.files[0].name}`;
        showNotification('Date/time added to image!', 'success');
      };
      img.src = dateImageData;
    });

    // Save date/time image
    saveDateTimeImage.addEventListener('click', function() {
      if (!dateResult.src || dateResult.src.startsWith('#')) {
        showNotification('Please add date/time to an image first!', 'error');
        return;
      }

      const link = document.createElement('a');
      link.download = 'date-time-image.png';
      link.href = dateResult.src;
      link.click();
      showNotification('Date/time image saved!', 'success');
    });

    // ==================== FACE DETECTION (IMAGE) ====================
    const faceImageUpload = document.getElementById('faceImageUpload');
    const facePreview = document.getElementById('facePreview');
    const faceFileName = document.getElementById('faceFileName');
    const facePlaceholder = document.getElementById('facePlaceholder');
    const detectFacesButton = document.getElementById('detectFacesButton');
    const clearFacesButton = document.getElementById('clearFacesButton');
    const detectionCanvas = document.getElementById('detectionCanvas');
    const detectionResult = document.getElementById('detectionResult');
    const detectionPlaceholder = document.getElementById('detectionPlaceholder');
    const rectColor = document.getElementById('rectColor');
    const rectThickness = document.getElementById('rectThickness');
    const saveFaceDetectionImage = document.getElementById('saveFaceDetectionImage');
    let faceImageData = null;

    faceImageUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        faceFileName.textContent = `Selected: ${file.name}`;
        faceFileName.style.color = '#00bcd4';
        const reader = new FileReader();
        reader.onload = function(e) {
          facePreview.src = e.target.result;
          facePreview.style.display = 'block';
          facePlaceholder.style.display = 'none';
          faceImageData = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        faceFileName.textContent = 'No file selected';
        faceFileName.style.color = '';
      }
    });

    detectFacesButton.addEventListener('click', function() {
      if (!faceImageData) {
        showNotification('Please upload an image first!', 'error');
        return;
      }
      if (!openCvReady || !haarCascade) {
        showNotification('Face detection model is still loading. Please try again in a moment.', 'warning');
        return;
      }
      try {
        detectFacesButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Detecting...</span>';
        detectFacesButton.disabled = true;
        const img = new Image();
        img.onload = function() {
          const src = cv.imread(img);
          const gray = new cv.Mat();
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);
          const faces = new cv.RectVector();
          const minSize = new cv.Size(0, 0);
          haarCascade.detectMultiScale(gray, faces, 1.1, 3, 0, minSize, minSize);
          const color = hexToScalar(rectColor.value);
          const thickness = parseInt(rectThickness.value);
          for (let i = 0; i < faces.size(); i++) {
            const face = faces.get(i);
            const point1 = new cv.Point(face.x, face.y);
            const point2 = new cv.Point(face.x + face.width, face.y + face.height);
            cv.rectangle(src, point1, point2, color, thickness);
          }
          const text = `${faces.size()} ${faces.size() === 1 ? 'face' : 'faces'} detected`;
          const textPoint = new cv.Point(20, 40);
          cv.putText(src, text, textPoint, cv.FONT_HERSHEY_SIMPLEX, 1.5, color, thickness);
          detectionCanvas.width = img.width;
          detectionCanvas.height = img.height;
          cv.imshow(detectionCanvas, src);
          detectionResult.src = detectionCanvas.toDataURL();
          detectionResult.style.display = 'block';
          detectionPlaceholder.style.display = 'none';
          detectionResult.style.transform = 'scale(0.95)';
          detectionResult.style.opacity = '0';
          setTimeout(() => {
            detectionResult.style.transition = 'all 0.7s ease';
            detectionResult.style.transform = 'scale(1)';
            detectionResult.style.opacity = '1';
          }, 50);
          showNotification(`${faces.size()} ${faces.size() === 1 ? 'face' : 'faces'} detected!`, 'success');
          faceFileName.textContent = `${faces.size()} ${faces.size() === 1 ? 'face' : 'faces'} detected!`;
          faceFileName.style.color = '#00bcd4';
          src.delete();
          gray.delete();
          faces.delete();
          detectFacesButton.innerHTML = '<i class="fas fa-search"></i><span>Detect Faces</span>';
          detectFacesButton.disabled = false;
        };
        img.src = faceImageData;
      } catch (error) {
        console.error('Face detection error:', error);
        showNotification('Face detection failed. Please try another image.', 'error');
        detectFacesButton.innerHTML = '<i class="fas fa-search"></i><span>Detect Faces</span>';
        detectFacesButton.disabled = false;
      }
    });

    clearFacesButton.addEventListener('click', function() {
      if (!faceImageData) return;

      const img = new Image();
      img.onload = function() {
        detectionCanvas.width = img.width;
        detectionCanvas.height = img.height;
        const ctx = detectionCanvas.getContext('2d');
        ctx.drawImage(img, 0, 0);
        detectionResult.style.display = 'none';
        detectionPlaceholder.style.display = 'block';
        faceFileName.textContent = `Selected: ${faceImageUpload.files[0].name}`;
        showNotification('Detection cleared!', 'success');
      };
      img.src = faceImageData;
    });

    saveFaceDetectionImage.addEventListener('click', function() {
      if (!detectionResult.src || detectionResult.src.startsWith('#')) {
        showNotification('Please detect faces first!', 'error');
        return;
      }
      const link = document.createElement('a');
      link.download = 'face-detection.png';
      link.href = detectionResult.src;
      link.click();
      showNotification('Face detection image saved!', 'success');
    });

    // ==================== FACE DETECTION (VIDEO) ====================
    const faceVideoUpload = document.getElementById('faceVideoUpload');
    const faceVideoFileName = document.getElementById('faceVideoFileName');
    const videoInfo = document.getElementById('videoInfo');
    const videoDuration = document.getElementById('videoDuration');
    const videoFrames = document.getElementById('videoFrames');
    const videoSize = document.getElementById('videoSize');
    const startDetectionButton = document.getElementById('startDetectionButton');
    const stopDetectionButton = document.getElementById('stopDetectionButton');
    const clearVideoDetectionButton = document.getElementById('clearVideoDetectionButton');
    const inputVideo = document.getElementById('inputVideo');
    const videoDetectionCanvas = document.getElementById('videoDetectionCanvas');
    const videoResult = document.getElementById('videoResult');
    const videoDetectionPlaceholder = document.getElementById('videoDetectionPlaceholder');
    const videoResultSection = document.getElementById('videoResultSection');
    const videoRectColor = document.getElementById('videoRectColor');
    const videoRectThickness = document.getElementById('videoRectThickness');
    const saveVideoFrameButton = document.getElementById('saveVideoFrameButton');
    const frameCountButton = document.getElementById('frameCountButton');
    const dateTimeButton = document.getElementById('dateTimeButton');
    const frameGallery = document.getElementById('frameGallery');
    const videoOverlay = document.getElementById('videoOverlay');

    let videoProcessing = false;
    let videoSource = null;
    let showDateTime = false;
    let dateTimeInterval = null; // For date/time updates

    // Handle video upload
    faceVideoUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];

      if (file) {
        // Check file size (max 200MB)
        const maxSize = 200 * 1024 * 1024; // 200MB in bytes
        if (file.size > maxSize) {
          alert('Video file is too large. Maximum allowed size is 200MB.');
          faceVideoUpload.value = '';
          faceVideoFileName.textContent = 'No file selected';
          return;
        }

        // Display file size
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        faceVideoFileName.textContent = `Selected: ${file.name}`;
        faceVideoFileName.style.color = '#00bcd4';

        const videoURL = URL.createObjectURL(file);
        inputVideo.src = videoURL;
        inputVideo.style.display = 'block';
        videoResultSection.style.display = 'block';
        videoOverlay.style.display = 'none';

        // Reset frame gallery
        frameGallery.style.display = 'none';
        frameGallery.innerHTML = '';

        // Update video info
        inputVideo.addEventListener('loadedmetadata', function() {
          const duration = inputVideo.duration;
          const estimatedFrames = Math.round(duration * 30); // Estimate at 30fps

          videoDuration.textContent = `${duration.toFixed(2)}s`;
          videoFrames.textContent = estimatedFrames;
          videoSize.textContent = `${fileSizeMB} MB`;
          videoInfo.style.display = 'flex';
        });

        // Hide frame gallery if visible
        frameGallery.style.display = 'none';
        frameGallery.innerHTML = '';
      } else {
        faceVideoFileName.textContent = 'No file selected';
        faceVideoFileName.style.color = '';
        videoInfo.style.display = 'none';
      }
    });

    // Update date/time overlay
    function updateDateTimeOverlay() {
      if (!showDateTime) return;

      const now = new Date();
      videoOverlay.textContent = now.toLocaleString();
      videoOverlay.style.display = 'block';
    }

    // Start video face detection
    startDetectionButton.addEventListener('click', function() {
      if (!inputVideo.src) {
        alert('Please upload a video first!');
        return;
      }

      if (!openCvReady || !haarCascade) {
        alert('Face detection model is still loading. Please try again in a moment.');
        return;
      }

      // Set canvas dimensions to match video
      videoDetectionCanvas.width = inputVideo.videoWidth;
      videoDetectionCanvas.height = inputVideo.videoHeight;

      videoProcessing = true;
      videoDetectionCanvas.style.display = 'block';
      inputVideo.style.display = 'none';

      // Start updating date/time
      if (showDateTime) {
        updateDateTimeOverlay();
        dateTimeInterval = setInterval(updateDateTimeOverlay, 1000);
      }

      // Start processing
      processVideo();
    });

    // Stop video face detection
    stopDetectionButton.addEventListener('click', function() {
      videoProcessing = false;
      inputVideo.style.display = 'block';
      videoDetectionCanvas.style.display = 'none';
      videoOverlay.style.display = 'none';

      // Clear date/time interval
      if (dateTimeInterval) {
        clearInterval(dateTimeInterval);
        dateTimeInterval = null;
      }
    });

    // Clear video detection
    clearVideoDetectionButton.addEventListener('click', function() {
      videoProcessing = false;
      const ctx = videoDetectionCanvas.getContext('2d');
      ctx.clearRect(0, 0, videoDetectionCanvas.width, videoDetectionCanvas.height);

      videoDetectionCanvas.style.display = 'none';
      inputVideo.style.display = 'block';
      videoOverlay.style.display = 'none';

      // Clear date/time interval
      if (dateTimeInterval) {
        clearInterval(dateTimeInterval);
        dateTimeInterval = null;
      }
    });

    // Save video frame
    saveVideoFrameButton.addEventListener('click', function() {
      if (!videoDetectionCanvas || !videoProcessing) {
        alert('Please start detection first!');
        return;
      }

      const link = document.createElement('a');
      link.download = 'video-frame.png';
      link.href = videoDetectionCanvas.toDataURL();
      link.click();
    });

    // Toggle date/time display
    dateTimeButton.addEventListener('click', function() {
      showDateTime = !showDateTime;
      if (showDateTime) {
        dateTimeButton.style.background = '#00bcd4';
        dateTimeButton.style.color = '#121212';

        // If video is processing, start updating date/time
        if (videoProcessing) {
          if (!dateTimeInterval) {
            updateDateTimeOverlay();
            dateTimeInterval = setInterval(updateDateTimeOverlay, 1000);
          }
          videoOverlay.style.display = 'block';
        }
      } else {
        dateTimeButton.style.background = '';
        dateTimeButton.style.color = '';

        // If video is processing, stop updating date/time
        if (videoProcessing) {
          if (dateTimeInterval) {
            clearInterval(dateTimeInterval);
            dateTimeInterval = null;
          }
          videoOverlay.style.display = 'none';
        }
      }
    });

    // Extract frames
    frameCountButton.addEventListener('click', function() {
      if (!inputVideo.src) {
        alert('Please upload a video first!');
        return;
      }

      // Clear previous frames
      frameGallery.innerHTML = '<div class="result-title">Extracted Frames</div>';
      frameGallery.style.display = 'grid';

      // Create a canvas for capturing frames
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');

      // Set canvas dimensions to match video
      canvas.width = inputVideo.videoWidth;
      canvas.height = inputVideo.videoHeight;

      let frameCount = 0;
      const fps = 1; // Extract 1 frame per second
      const duration = inputVideo.duration;

      // Function to capture frame at a specific time
      function captureFrame(time) {
        if (time > duration) return;

        inputVideo.currentTime = time;

        // Wait for seek to complete
        inputVideo.onseeked = function() {
          ctx.drawImage(inputVideo, 0, 0, canvas.width, canvas.height);

          // Create frame item
          const frameData = canvas.toDataURL();

          const frameItem = document.createElement('div');
          frameItem.className = 'frame-item';

          const frameImg = document.createElement('img');
          frameImg.src = frameData;

          const frameNumber = document.createElement('div');
          frameNumber.className = 'frame-number';
          frameNumber.textContent = `Frame ${frameCount + 1}`;

          frameItem.appendChild(frameImg);
          frameItem.appendChild(frameNumber);

          frameGallery.appendChild(frameItem);

          frameCount++;

          // Capture next frame after 1 second
          setTimeout(() => captureFrame(time + 1), 100);
        };
      }

      // Start capturing frames
      captureFrame(0);
    });

    // Process video frames for face detection
    function processVideo() {
      if (!videoProcessing) return;

      try {
        // Create a temporary canvas to capture the video frame
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = inputVideo.videoWidth;
        tempCanvas.height = inputVideo.videoHeight;
        const tempCtx = tempCanvas.getContext('2d');

        // Draw current video frame to the temp canvas
        tempCtx.drawImage(inputVideo, 0, 0, tempCanvas.width, tempCanvas.height);

        // Convert to OpenCV Mat
        const src = cv.imread(tempCanvas);
        const gray = new cv.Mat();
        cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

        // Detect faces
        const faces = new cv.RectVector();
        const minSize = new cv.Size(0, 0);
        haarCascade.detectMultiScale(gray, faces, 1.1, 3, 0, minSize, minSize);

        // Draw rectangles around detected faces
        const color = hexToRgb(videoRectColor.value);
        const thickness = parseInt(videoRectThickness.value);

        for (let i = 0; i < faces.size(); i++) {
          const face = faces.get(i);
          const point1 = new cv.Point(face.x, face.y);
          const point2 = new cv.Point(face.x + face.width, face.y + face.height);
          cv.rectangle(src, point1, point2, [color.r, color.g, color.b, 255], thickness);
        }

        // Draw number of faces detected
        const text = `${faces.size()} ${faces.size() === 1 ? 'face' : 'faces'} detected`;
        const textPoint = new cv.Point(20, 40);
        const textColor = [color.r, color.g, color.b, 255];
        const textScale = 1.5;
        const textThickness = 2;
        cv.putText(src, text, textPoint, cv.FONT_HERSHEY_SIMPLEX, textScale, textColor, textThickness);

        // Display the result
        cv.imshow(videoDetectionCanvas, src);

        // Clean up
        src.delete();
        gray.delete();
        faces.delete();

        // Continue processing
        requestAnimationFrame(processVideo);
      } catch (error) {
        console.error('Video face detection error:', error);
        videoProcessing = false;
      }
    }

    // ==================== EDGE DETECTION ====================
    const edgeUpload = document.getElementById('edgeUpload');
    const edgeFileName = document.getElementById('edgeFileName');
    const edgePreview = document.getElementById('edgePreview');
    const edgePlaceholder = document.getElementById('edgePlaceholder');
    const threshold1 = document.getElementById('threshold1');
    const threshold2 = document.getElementById('threshold2');
    const threshold1Value = document.getElementById('threshold1Value');
    const threshold2Value = document.getElementById('threshold2Value');
    const edgeType = document.getElementById('edgeType');
    const detectEdgesBtn = document.getElementById('detectEdgesBtn');
    const detectCornersBtn = document.getElementById('detectCornersBtn');
    const edgeResult = document.getElementById('edgeResult');
    const edgeResultPlaceholder = document.getElementById('edgeResultPlaceholder');
    const saveEdgeImage = document.getElementById('saveEdgeImage');
    let edgeImageData = null;

    threshold1.addEventListener('input', function() {
      threshold1Value.textContent = threshold1.value;
    });
    threshold2.addEventListener('input', function() {
      threshold2Value.textContent = threshold2.value;
    });

    edgeUpload.addEventListener('change', function(event) {
      const file = event.target.files[0];
      if (file) {
        edgeFileName.textContent = `Selected: ${file.name}`;
        edgeFileName.style.color = '#00bcd4';
        const reader = new FileReader();
        reader.onload = function(e) {
          edgePreview.src = e.target.result;
          edgePreview.style.display = 'block';
          edgePlaceholder.style.display = 'none';
          edgeImageData = e.target.result;
        }
        reader.readAsDataURL(file);
      } else {
        edgeFileName.textContent = 'No file selected';
        edgeFileName.style.color = '';
      }
    });

    detectEdgesBtn.addEventListener('click', function() {
      if (!edgeImageData) {
        showNotification('Please upload an image first!', 'error');
        return;
      }
      if (typeof cv === 'undefined') {
        showNotification('OpenCV.js is still loading. Please try again in a moment.', 'warning');
        return;
      }

      try {
        detectEdgesBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Processing...</span>';
        detectEdgesBtn.disabled = true;

        const img = new Image();
        img.onload = function() {
          const src = cv.imread(img);
          const gray = new cv.Mat();
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

          // Apply Gaussian blur
          const blurred = new cv.Mat();
          cv.GaussianBlur(gray, blurred, new cv.Size(5, 5), 0);

          let edges = new cv.Mat();
          const t1 = parseInt(threshold1.value);
          const t2 = parseInt(threshold2.value);
          const edgeMethod = edgeType.value;

          if (edgeMethod === 'canny') {
            cv.Canny(blurred, edges, t1, t2);
          } else if (edgeMethod === 'sobel') {
            const sobelX = new cv.Mat();
            const sobelY = new cv.Mat();
            cv.Sobel(blurred, sobelX, cv.CV_8U, 1, 0, 3, 1, 0, cv.BORDER_DEFAULT);
            cv.Sobel(blurred, sobelY, cv.CV_8U, 0, 1, 3, 1, 0, cv.BORDER_DEFAULT);
            cv.addWeighted(sobelX, 0.5, sobelY, 0.5, 0, edges);
            sobelX.delete();
            sobelY.delete();
          } else if (edgeMethod === 'laplacian') {
            cv.Laplacian(blurred, edges, cv.CV_8U, 3, 1, 0, cv.BORDER_DEFAULT);
          }

          // Convert to RGBA for display
          const dst = new cv.Mat();
          cv.cvtColor(edges, dst, cv.COLOR_GRAY2RGBA);

          // Display result
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          cv.imshow(canvas, dst);

          edgeResult.src = canvas.toDataURL();
          edgeResult.style.display = 'block';
          edgeResultPlaceholder.style.display = 'none';

          // Animation
          edgeResult.style.transform = 'scale(0.95)';
          edgeResult.style.opacity = '0';
          setTimeout(() => {
            edgeResult.style.transition = 'all 0.7s ease';
            edgeResult.style.transform = 'scale(1)';
            edgeResult.style.opacity = '1';
          }, 50);

          // Clean up
          src.delete();
          gray.delete();
          blurred.delete();
          edges.delete();
          dst.delete();

          showNotification(`${edgeMethod} edge detection applied!`, 'success');
          edgeFileName.textContent = `${edgeMethod} edge detection applied!`;
          edgeFileName.style.color = '#00bcd4';

          detectEdgesBtn.innerHTML = '<i class="fas fa-border-all"></i><span>Detect Edges</span>';
          detectEdgesBtn.disabled = false;
        };
        img.src = edgeImageData;
      } catch (error) {
        console.error('Edge detection error:', error);
        showNotification('Edge detection failed. Please try another image.', 'error');
        detectEdgesBtn.innerHTML = '<i class="fas fa-border-all"></i><span>Detect Edges</span>';
        detectEdgesBtn.disabled = false;
      }
    });

    // Corner detection (Harris)
    detectCornersBtn.addEventListener('click', function() {
      if (!edgeImageData) {
        showNotification('Please upload an image first!', 'error');
        return;
      }
      if (typeof cv === 'undefined') {
        showNotification('OpenCV.js is still loading. Please try again in a moment.', 'warning');
        return;
      }

      try {
        detectCornersBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Processing...</span>';
        detectCornersBtn.disabled = true;

        const img = new Image();
        img.onload = function() {
          const src = cv.imread(img);
          const gray = new cv.Mat();
          cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

          // Harris corner detection parameters
          const blockSize = 2;
          const apertureSize = 3;
          const k = 0.04;
          const thresholdValue = parseInt(threshold1.value) / 100; // Adjust threshold

          // Harris corner detection
          const dst = new cv.Mat();
          const dst_norm = new cv.Mat();
          const dst_norm_scaled = new cv.Mat();
          cv.cornerHarris(gray, dst, blockSize, apertureSize, k);
          cv.normalize(dst, dst_norm, 0, 255, cv.NORM_MINMAX, cv.CV_32FC1);
          cv.convertScaleAbs(dst_norm, dst_norm_scaled);

          // Draw circles at corners
          const color = new cv.Scalar(0, 255, 0, 255); // Green
          for (let i = 0; i < dst_norm.rows; i++) {
            for (let j = 0; j < dst_norm.cols; j++) {
              if (dst_norm.floatPtr(i, j)[0] > thresholdValue * 255) {
                cv.circle(src, new cv.Point(j, i), 5, color, 2, cv.LINE_AA);
              }
            }
          }

          // Display result
          const canvas = document.createElement('canvas');
          canvas.width = img.width;
          canvas.height = img.height;
          cv.imshow(canvas, src);

          edgeResult.src = canvas.toDataURL();
          edgeResult.style.display = 'block';
          edgeResultPlaceholder.style.display = 'none';

          // Animation
          edgeResult.style.transform = 'scale(0.95)';
          edgeResult.style.opacity = '0';
          setTimeout(() => {
            edgeResult.style.transition = 'all 0.7s ease';
            edgeResult.style.transform = 'scale(1)';
            edgeResult.style.opacity = '1';
          }, 50);

          // Clean up
          src.delete();
          gray.delete();
          dst.delete();
          dst_norm.delete();
          dst_norm_scaled.delete();

          showNotification('Corner detection applied!', 'success');
          edgeFileName.textContent = 'Corner detection applied!';
          edgeFileName.style.color = '#00bcd4';

          detectCornersBtn.innerHTML = '<i class="fas fa-dot-circle"></i><span>Detect Corners</span>';
          detectCornersBtn.disabled = false;
        };
        img.src = edgeImageData;
      } catch (error) {
        console.error('Corner detection error:', error);
        showNotification('Corner detection failed. Please try another image.', 'error');
        detectCornersBtn.innerHTML = '<i class="fas fa-dot-circle"></i><span>Detect Corners</span>';
        detectCornersBtn.disabled = false;
      }
    });

    saveEdgeImage.addEventListener('click', function() {
      if (!edgeResult.src || edgeResult.src.startsWith('#')) {
        showNotification('Please detect edges first!', 'error');
        return;
      }
      const link = document.createElement('a');
      link.download = 'edge-detection.png';
      link.href = edgeResult.src;
      link.click();
      showNotification('Edge detection image saved!', 'success');
    });

    // Clean up when leaving the page
    window.addEventListener('beforeunload', function() {
      if (videoProcessing) {
        stopVideoProcessing();
      }
    });
  </script>
</body>
</html>